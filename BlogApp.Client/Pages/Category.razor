@page "/category/{Slug}"
@inject ApiService ApiService

<PageTitle>@(category?.Name ?? "Category") - Blog App</PageTitle>

<div class="container mt-4">
    @if (category != null)
    {
        <h1>@category.Name</h1>
        @if (!string.IsNullOrEmpty(category.Description))
        {
            <p class="text-muted">@category.Description</p>
        }
        
        <h3 class="mt-4">Posts (@posts?.TotalCount ?? 0)</h3>
        
        @if (posts?.Items != null && posts.Items.Any())
        {
            @foreach (var post in posts.Items)
            {
                <article class="card mb-3">
                    <div class="card-body">
                        <h4 class="card-title">
                            <a href="/post/@post.Slug" class="text-decoration-none">@post.Title</a>
                        </h4>
                        @if (!string.IsNullOrEmpty(post.Excerpt))
                        {
                            <p class="card-text">@post.Excerpt</p>
                        }
                        <small class="text-muted">
                            @if (post.PublishedAt.HasValue)
                            {
                                <span>@post.PublishedAt.Value.ToString("MMMM dd, yyyy")</span>
                            }
                            @if (post.ReadingTimeMinutes.HasValue)
                            {
                                <span class="ms-2">â€¢ @post.ReadingTimeMinutes min read</span>
                            }
                        </small>
                    </div>
                </article>
            }
        }
        else
        {
            <p>No posts in this category yet.</p>
        }
    }
    else
    {
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public string Slug { get; set; } = string.Empty;
    
    private CategoryDto? category;
    private PagedResult<PostSummaryDto>? posts;

    protected override async Task OnInitializedAsync()
    {
        await LoadCategory();
        await LoadPosts();
    }

    private async Task LoadCategory()
    {
        category = await ApiService.GetAsync<CategoryDto>($"api/categories/slug/{Slug}");
    }

    private async Task LoadPosts()
    {
        posts = await ApiService.GetAsync<PagedResult<PostSummaryDto>>($"api/posts?category={Slug}&pageSize=20");
    }
}
